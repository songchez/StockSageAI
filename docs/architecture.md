# StockSage AI LangGraph 아키텍처 설계 문서

StockSage AI는 LangGraph를 활용하여 시장 분석, 종목 선별, 투자 전략 수립 등의 투자 의사결정 프로세스를 자동화합니다. 이 문서는 LangGraph 노드 구조와 상태 관리 방식을 설명합니다.

## 1. 그래프 상태 관리

투자 의사결정 그래프의 핵심은 노드 간에 공유되는 상태(`InvestmentState`)입니다. 이 상태는 분석 과정에서 생성된 모든 데이터를 저장하고 노드 간에 전달합니다.

### 1.1 상태 구조 (InvestmentState)

```python
class InvestmentState(BaseModel):
    # 사용자 관련 정보
    user_input: str  # 사용자 질문/요청
    user_query_type: str  # 쿼리 유형 (market, sector, specific_stock, strategy, general)
    user_profile: Dict[str, Any]  # 사용자 투자 프로필

    # 야후 파이낸스 원시 데이터 (모든 노드가 공유)
    raw_market_data: Dict[str, Any]  # 시장 데이터
    raw_sector_data: Dict[str, Any]  # 섹터 데이터
    raw_stock_data: Dict[str, Dict[str, Any]]  # 종목별 데이터

    # 각 분석 단계의 결과
    market_analysis: Dict[str, Any]  # 시장 분석 결과
    sector_analysis: Dict[str, Any]  # 섹터 분석 결과
    screened_stocks: List[Dict[str, Any]]  # 스크리닝된 종목 목록
    stock_analysis: Dict[str, Any]  # 종목 분석 결과
    investment_strategy: Dict[str, Any]  # 투자 전략

    # 최종 추천 및 결과
    recommendations: List[Dict[str, Any]]  # 추천 종목 목록
    final_answer: str  # 최종 응답 텍스트

    # 그래프 실행 제어
    current_node: str  # 현재 실행 중인 노드
    errors: List[str]  # 오류 메시지 목록

    # 메시지 히스토리
    messages: List[Dict[str, str]]  # 노드 간 메시지
```

## 2. 노드 구조 및 역할

StockSage AI 그래프는 다음과 같은 노드로 구성됩니다:

### 2.1 MarketAnalystNode

**역할**: 전체 시장 상황을 분석하고 시장 상태(강세/약세/횡보)를 판단합니다.

**데이터 흐름**:

- **입력**: 사용자 쿼리, 사용자 프로필
- **처리**: 야후 파이낸스에서 시장 데이터를 가져와 LLM으로 분석
- **출력**: 시장 상태, 시장 분석 요약
- **다음 노드**: SectorAnalystNode

### 2.2 SectorAnalystNode

**역할**: 다양한 섹터의 성과를 분석하고 강세 섹터를 식별합니다.

**데이터 흐름**:

- **입력**: 시장 분석 결과, 사용자 프로필
- **처리**: 야후 파이낸스에서 섹터 데이터를 가져와 LLM으로 분석
- **출력**: 강세 섹터 목록, 섹터 분석 요약
- **다음 노드**:
  - 쿼리 유형이 "sector"인 경우 → ResultCompilerNode
  - 그 외 → StockScreenerNode

### 2.3 StockScreenerNode

**역할**: 시장 및 섹터 분석 결과를 활용하여 종목 스크리닝을 수행합니다.

**데이터 흐름**:

- **입력**: 시장 분석 결과, 섹터 분석 결과, 사용자 프로필
- **처리**: 야후 파이낸스 API로 종목 스크리닝 후 LLM으로 필터링
- **출력**: 선별된 종목 목록
- **다음 노드**:
  - 쿼리 유형이 "specific_stock"인 경우 → StockAnalystNode
  - 그 외 → StrategyAdvisorNode

### 2.4 StockAnalystNode

**역할**: 특정 종목에 대한 심층 분석을 수행합니다.

**데이터 흐름**:

- **입력**: 시장 분석 결과, 섹터 분석 결과, 대상 종목
- **처리**: 야후 파이낸스에서 종목 데이터를 가져와 LLM으로 분석
- **출력**: 종목 분석 결과, 투자 권장 여부
- **다음 노드**: StrategyAdvisorNode

### 2.5 StrategyAdvisorNode

**역할**: 모든 분석 결과를 종합하여 구체적인 투자 전략을 수립합니다.

**데이터 흐름**:

- **입력**: 시장 분석, 섹터 분석, 종목 분석/스크리닝 결과, 사용자 프로필
- **처리**: 지지/저항 레벨 분석 후 LLM으로 투자 전략 수립
- **출력**: 진입 전략, 목표가, 손절가, 투자 비중 등
- **다음 노드**: ResultCompilerNode

### 2.6 ResultCompilerNode

**역할**: 모든 분석 결과를 종합하여 최종 응답을 생성합니다.

**데이터 흐름**:

- **입력**: 모든 이전 노드의 분석 결과
- **처리**: LLM을 사용해 쿼리 유형에 맞는 최종 응답 생성
- **출력**: 사용자에게 제공할 최종 응답 텍스트
- **다음 노드**: END (그래프 종료)

## 3. 데이터 흐름 시각화

```
  ┌───────────────┐
  │ 야후 파이낸스 │
  │    API 데이터   │
  └───────┬───────┘
          │ 공유
          ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│ MarketAnalyst   │ ──▶ │ SectorAnalyst   │ ──▶ │ StockScreener   │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                   │                      │
                                   │                      │
                                   │                      ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│ ResultCompiler  │ ◀── │ StrategyAdvisor │ ◀── │ StockAnalyst    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
        │
        ▼
┌─────────────────┐
│   최종 응답     │
└─────────────────┘
```

## 4. LLM 프롬프팅 전략

각 노드는 복잡한 로직 대신 LLM 프롬프팅을 활용합니다:

1. **컨텍스트 집약적 프롬프트**: 각 노드는 이전 단계의 분석 결과, 원시 데이터, 사용자 프로필 등 모든 관련 정보를 프롬프트에 포함합니다.

2. **명확한 지시사항**: 각 프롬프트는 LLM에게 특정 분석 작업과 출력 형식을 명확히 지시합니다.

3. **역할 기반 접근**: 각 노드는 LLM에게 특정 역할(시장 분석가, 섹터 분석가, 주식 선별 전문가 등)을 부여합니다.

4. **구조화된 응답 요청**: 프롬프트는 명확한 구조(번호 매기기, 단계별 분석 등)를 갖춘 응답을 요청합니다.

## 5. 확장성 및 유지보수

### 5.1 새로운 노드 추가

새로운 분석 단계를 추가하려면:

1. 해당 노드 클래스 정의 (`langgraph_nodes` 디렉토리에 파일 추가)
2. `InvestmentState`에 관련 필드 추가
3. `graph_builder.py`에서 그래프 구성 업데이트

### 5.2 데이터 소스 교체

야후 파이낸스 외의 데이터 소스를 사용하려면:

1. 새 데이터 소스에 대한 MCP 서버 구현
2. `mcp_server_config.json` 업데이트
3. 필요한 경우 노드 내의 데이터 처리 로직 수정

## 6. 성능 최적화

### 6.1 데이터 공유 전략

- **원시 데이터 재사용**: 모든 원시 데이터는 상태에 저장되어 노드 간에 공유됩니다.
- **중복 API 호출 방지**: 각 노드는 필요한 데이터가 이미 상태에 있는지 확인 후 없는 경우에만 API를 호출합니다.

### 6.2 LLM 호출 최적화

- **효율적인 프롬프트**: 각 노드는 필요한 정보만 포함한 간결한 프롬프트를 사용합니다.
- **세분화된 작업**: 각 노드는 특정 분석 작업에 집중하여 LLM의 응답 품질을 높입니다.

## 7. 오류 처리

- **그래프 수준 오류 처리**: 각 노드에서 발생한 오류는 상태의 `errors` 목록에 추가됩니다.
- **우아한 실패**: 노드에서 오류가 발생해도 그래프는 "error" 노드로 전환하여 사용자에게 오류 정보를 제공합니다.
